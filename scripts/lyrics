#!/usr/bin/env bash
# Dependencies: flac, ffmpeg (for non-flac)

MUSIC_DIR="/mnt/DATA/Music"

find "$MUSIC_DIR" -type f \( -name "*.flac" -o -name "*.mp3" -o -name "*.m4a" \) | while read -r file; do
    # Define the output .lrc file path
    lrc_file="${file%.*}.lrc"

    # Skip if .lrc already exists (efficiency!)
    [[ -f "$lrc_file" ]] && continue

    echo "Scanning: $(basename "$file")"

    if [[ "$file" == *.flac ]]; then
        # Use metaflac for surgical precision on FLACs
        lyrics=$(metaflac --show-tag=LYRICS "$file" | sed 's/^LYRICS=//')
    else
        # Use ffmpeg for other formats (mp3, m4a, etc.)
        lyrics=$(ffprobe -v error -show_entries format_tags=lyrics -of default=noprint_wrappers=1:nokey=1 "$file")
    fi

    # If lyrics found, write to file
    if [[ -n "$lyrics" ]]; then
        echo -e "$lyrics" > "$lrc_file"
        echo "Successfully extracted lyrics to $(basename "$lrc_file")"
    fi
done
